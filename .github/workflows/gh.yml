name: Publish package to GitHub Packages
on:
    push:
        branches: ['main']
jobs:
    test_and_build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout project sources
              uses: actions/checkout@v3

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v2

            - name: Run tests
              run: ./gradlew test

            - name: Run build with Gradle Wrapper
              run: ./gradlew build

    publish_to_gh_packages:
        runs-on: ubuntu-latest
        needs: test_and_build
        permissions:
            contents: read
            packages: write
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-java@v3
              with:
                  java-version: '8'
                  distribution: 'temurin'
            - name: Publish package
              run: mvn --batch-mode deploy
              env:
                  GITHUB_TOKEN: ${{ secrets.TOKEN }}
